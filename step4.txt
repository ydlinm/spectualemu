Role: Data Engineer for Scientific Machine Learning
Task: Implement Step 4: The Data Factory (Physics-Corrected Batch Generation)
Context: We are generating synthetic data to train a Deep Learning model to unmix skin composition from hyperspectral subsurface scattering (SSS) images.
CRITICAL PHYSICS CORRECTION: Skin "oil" is physically Sebum (a hydro-lipid emulsion), not pure lipid. We must mathematically separate Free Water ($C_{free\_water}$) inside the skin from the Sebum ($C_{sebum}$) on the surface, even though Sebum itself contains water.
Requirements for the Data Generation Loop:
1. Define the Spectral Endmembers (Run Once):
•	$Spec_{water}$: Loaded from water_mu_a.csv.
•	$Spec_{lipid}$: Loaded from lipid_mu_a.csv.
•	$Spec_{melanin}$: Generated via Jacques Model ($1.7 \times 10^{12} \cdot \lambda^{-3.48}$).
•	Construct Target Endmember: $Spec_{sebum}(\lambda) = 0.3 \times Spec_{water}(\lambda) + 0.7 \times Spec_{lipid}(\lambda)$.
2. Domain Randomization (Run per sample):
•	Sample Free Water concentration: $C_{free\_water} \sim Uniform(0.20, 0.60)$.
•	Sample Sebum concentration: $C_{sebum} \sim Uniform(0.05, 0.25)$.
•	Sample Melanin concentration: $C_{mel} \sim Uniform(0.00, 0.10)$.
•	Constraint Check: Assert (C_free_water + C_sebum + C_mel) < 0.95.
•	Sample Scattering Parameters: $a \sim Uniform(1.0, 2.0)$, $b \sim Uniform(0.5, 1.5)$ for $\mu_s' = a(\lambda/500)^{-b}$.
•	Texture Modulation: Load skin_texture.png, apply random crop/rotation. Modulate the scalar concentrations ($C_{free\_water}, C_{sebum}$) with this texture to create spatially varying Ground Truth Maps (Shape: 256x256).
3. Physics Engine (Forward Pass):
•	Calculate total absorption at each pixel:
$\mu_{a, total}(x,y,\lambda) = GT_{free\_water}(x,y) \cdot Spec_{water} + GT_{sebum}(x,y) \cdot Spec_{sebum} + C_{mel} \cdot Spec_{melanin}$
•	Generate Scene_HyperCube using the Farrell dipole model (from Step 2) with the new $\mu_{a, total}$ and randomized $\mu_s'$.
•	Apply Prism Dispersion (Shift by $\Delta x$ using SF11 Cauchy equation).
•	Apply Sensor Model (Exposure, Saturation clipping at 4095 ADU, Shot Noise, Read Noise).
4. Data Output Format:
•	Save each iteration as sample_{id}.npz in a dataset/ folder.
•	x: Raw_Sensor_Image (Shape: [256, 256], dtype: uint16). This has the dispersed streaks and noise.
•	y: Ground_Truth_Stack (Shape: [2, 256, 256], dtype: float32).
o	Channel 0: The spatial map of $C_{free\_water}$
o	Channel 1: The spatial map of $C_{sebum}$
•	Do NOT save the hypercube to save disk space.
5. Verification:
•	Run a test batch of 5 samples.
•	Plot Sample 0: Show the Raw Input (Log scale), GT Free Water Map, and GT Sebum Map.

