
**Role:** Data Engineer for Computational Imaging.
**Task:** Implement `Step 4: The Data Factory (Batch Generation Pipeline)`.
**Objective:** Generate a synthetic training dataset for Spectral SSS Unmixing.

#### **Critical Physics Correction:**

* **Material Definition:**
* "Water" refers to Pure Water (`interp_water`).
* "Oil" refers to the **Sebum** spectrum (`target_sebum` from Step 1), which models the hydro-lipid film.


* **Randomization Logic:**
* We are **NOT** fixing the skin to 30% water / 70% oil.
* Instead, we randomly vary the **concentration** of "Pure Water" and "Sebum" independently.



#### **Workflow (The Loop):**

Create a class `DataFactory` that runs a loop  times. In each iteration:

**1. Domain Randomization (The "Recipe"):**

* **Biological Concentrations (Scalar Randoms):**
* `Conc_FreeWater`  (e.g., Dry skin to Hydrated skin).
* `Conc_Sebum`  (e.g., Matte skin to Oily skin).
* `Conc_Melanin`  (Background noise).
* *Physics Constraint:* Ensure `Conc_FreeWater + Conc_Sebum + Conc_Melanin <= 1.0`.


* **Spatial Texture Augmentation:**
* Load `skin_texture.png`.
* Apply random **Rotation**, **Flip**, and **Shift**.
* Generate two spatial weight maps:
* `Map_Water(x,y)`: Base `Conc_FreeWater` modulated by low-frequency Perlin noise (hydration varies slowly).
* `Map_Sebum(x,y)`: Base `Conc_Sebum` modulated by high-frequency Texture (oil follows pores/texture).





**2. Physics Update (The "Mixing"):**

* Calculate the effective  for the scene:


* Note:  is the pre-mixed spectrum from Step 1.

**3. Forward Simulation:**

* **Step 2 (Light Field):** Generate `Scene_HyperCube` using the updated  map.
* **Step 3 (Sensor):** Apply Prism Dispersion (SF11 model) and Sensor Noise.
* *Action:* Apply random exposure time variation () to simulate lighting changes.
* *Output:* `Raw_Sensor_Image` (The input features ).



**4. Data Saving:**

* Save as `sample_{id}.npz`:
* `x`: `Raw_Sensor_Image` (uint16, 256x256).
* `y`: Stacked maps of `Map_Water` and `Map_Sebum` (float32, 256x256x2).
* `meta`: Array `[Conc_FreeWater, Conc_Sebum]`.



#### **Validation:**

* Plot **one sample** showing:
* Input: The dispersed sensor image (with streaks).
* Ground Truth Channel 1: Water Distribution.
* Ground Truth Channel 2: Sebum Distribution.


* **Check:** Verify that the "Water Map" and "Sebum Map" look different (e.g., Sebum should align more with texture/pores).

